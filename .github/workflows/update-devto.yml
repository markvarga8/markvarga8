name: Update Dev.to Articles in README

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch: {}

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Fetch latest dev.to articles
        run: |
          curl -s "https://dev.to/api/articles?username=marxon&per_page=5" > devto.json

      - name: Build article list
        id: build
        run: |
          list=$(jq -r '.[] | "- [" + .title + "](" + .url + ")"' devto.json)
          echo "list<<EOF" >> $GITHUB_OUTPUT
          echo "$list" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update README safely
        run: |
          list="${{ steps.build.outputs.list }}"

          start="<!-- DEVTO-LIST:START -->"
          end="<!-- DEVTO-LIST:END -->"

          # Az egÃ©sz README tartalmÃ¡t beolvassuk
          content=$(cat README.md)

          # KicserÃ©ljÃ¼k a blokkot escape problÃ©mÃ¡k nÃ©lkÃ¼l
          new_content=$(echo "$content" | awk -v start="$start" -v end="$end" -v repl="$list" '
            $0 ~ start { print start; print repl; skip=1; next }
            $0 ~ end   { print end; skip=0; next }
            skip != 1  { print }
          ')

          printf "%s" "$new_content" > README.md

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git commit -m "ðŸ”„ Update latest dev.to articles" || echo "No changes to commit"
          git push
