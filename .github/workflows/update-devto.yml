name: Update Dev.to Articles in README

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch: {}

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Fetch latest dev.to articles
        id: devto
        run: |
          curl -s "https://dev.to/api/articles?username=marxon&per_page=5" > devto.json

      - name: Build markdown list
        id: build
        run: |
          list=$(jq -r '.[] | "- [" + .title + "](" + .url + ")"' devto.json)
          echo "list<<EOF" >> $GITHUB_OUTPUT
          echo "$list" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update README
        run: |
          list="${{ steps.build.outputs.list }}"
          
          sed -i "/<!-- DEVTO-LIST:START -->/,/<!-- DEVTO-LIST:END -->/c\\<!-- DEVTO-LIST:START -->\n$list\n<!-- DEVTO-LIST:END -->" README.md

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git commit -m "ðŸ”„ Update latest dev.to articles" || echo "No changes"
          git push
