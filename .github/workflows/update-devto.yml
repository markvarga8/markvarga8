name: Update Dev.to Articles in README (Thumbnails)

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch: {}

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install jq -y

      - name: Fetch latest dev.to articles
        run: |
          curl -s "https://dev.to/api/articles?username=marxon&per_page=5" > devto.json

      - name: Build HTML table
        id: build
        run: |
          # Build one <tr> row per article
          rows=$(jq -r '
            .[] |
            "<tr>\n" +
            "  <td width=\"200\">\n" +
            "    <img src=\"" + (.cover_image // "") + "\" width=\"200\" />\n" +
            "  </td>\n" +
            "  <td>\n" +
            "    <a href=\"" + .url + "\"><b>" + .title + "</b></a><br/>\n" +
            "    <sub>" + (.description | gsub("\n"; " ")) + "</sub>\n" +
            "  </td>\n" +
            "</tr>\n"
          ' devto.json)

          echo "table<<EOF" >> $GITHUB_OUTPUT
          echo "<table>" >> $GITHUB_OUTPUT
          echo "$rows" >> $GITHUB_OUTPUT
          echo "</table>" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update README
        run: |
          table="${{ steps.build.outputs.table }}"

          start="<!-- DEVTO-LIST:START -->"
          end="<!-- DEVTO-LIST:END -->"

          content=$(cat README.md)

          new_content=$(echo "$content" | awk -v start="$start" -v end="$end" -v repl="$table" '
            $0 ~ start { print start; print repl; skip=1; next }
            $0 ~ end   { print end; skip=0; next }
            skip != 1  { print }
          ')

          printf "%s" "$new_content" > README.md

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git commit -m "üñºÔ∏è Update latest DEV.to article thumbnails" || echo "No changes"
          git push
