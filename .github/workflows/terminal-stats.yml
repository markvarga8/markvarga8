name: Generate Terminal Contribution Stats

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *"

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Generate terminal SVG
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const username = "markvarga8";

            // === Get real GitHub contribution stats ===
            const query = `
              query($username: String!) {
                user(login: $username) {
                  name
                  contributionsCollection {
                    contributionCalendar {
                      totalContributions
                    }
                    totalCommitContributions
                    totalPullRequestContributions
                    totalIssueContributions
                  }
                }
              }
            `;

            const result = await github.graphql(query, { username });

            const user = result.user;

            const name = user.name || username;
            const totalContributions = user.contributionsCollection.contributionCalendar.totalContributions;
            const commitContrib = user.contributionsCollection.totalCommitContributions;
            const prContrib = user.contributionsCollection.totalPullRequestContributions;
            const issueContrib = user.contributionsCollection.totalIssueContributions;

            // === Lines to show (clean and focused) ===
            const lines = [
              `user: ${name}`,
              `contributions last year: ${totalContributions}`,
              `commits: ${commitContrib}`,
              `pull requests: ${prContrib}`,
              `issues: ${issueContrib}`
            ];

            const width = 520;
            const lineHeight = 24;
            const padding = 24;
            const height = padding * 2 + lineHeight * (lines.length + 2);

            // === Build SVG ===
            let svg = "";
            svg += `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">`;
            svg += `<style>@keyframes blink{0%,50%{opacity:1;}50.01%,100%{opacity:0;}}</style>`;
            svg += `<rect width="100%" height="100%" fill="#050816" rx="14"/>`;
            svg += `<text x="${padding}" y="${padding - 6}" fill="#00ff7f" font-family="monospace" font-size="14">Marxolution // terminal.stats</text>`;

            lines.forEach((text, i) => {
              svg += `<text x="${padding}" y="${padding + lineHeight * (i + 1)}" fill="#00ff7f" font-family="monospace" font-size="16">&gt; ${text}</text>`;
            });

            svg += `<text x="${padding + 8}" y="${padding + lineHeight * (lines.length + 1)}" fill="#00ff7f" font-family="monospace" font-size="16" style="animation: blink 1s infinite;">_</text>`;
            svg += `</svg>`;

            fs.mkdirSync("assets", { recursive: true });
            fs.writeFileSync("assets/terminal-stats.svg", svg);

      - name: Commit SVG
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add assets/terminal-stats.svg
          git commit -m "Update terminal contribution stats" || echo "No changes"
          git push
