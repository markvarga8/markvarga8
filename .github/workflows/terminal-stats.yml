name: Generate Terminal Stats

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *" # minden nap 05:00 UTC

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate terminal stats SVG
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const username = "markvarga8";

            // Fetch user profile
            const user = (await github.rest.users.getByUsername({ username })).data;

            // Fetch repos
            const repos = await github.paginate(
              github.rest.repos.listForUser,
              { username, per_page: 100 }
            );

            const publicRepos = repos.length;
            const totalStars = repos.reduce((a, r) => a + (r.stargazers_count || 0), 0);
            const totalForks = repos.reduce((a, r) => a + (r.forks_count || 0), 0);
            const followers = user.followers;

            const langCount = {};
            repos.forEach(r => {
              if (r.language) langCount[r.language] = (langCount[r.language] || 0) + 1;
            });

            const topLang = Object.entries(langCount)
              .sort((a, b) => b[1] - a[1])[0]?.[0] || "N/A";

            const lines = [
              `user: ${username}`,
              `public repos: ${publicRepos}`,
              `total stars: ${totalStars}`,
              `total forks: ${totalForks}`,
              `followers: ${followers}`,
              `top language: ${topLang}`
            ];

            const width = 520;
            const lineHeight = 24;
            const padding = 24;
            const height = padding * 2 + lineHeight * (lines.length + 2);

            let svg = "";
            svg += `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">`;
            svg += `<style>@keyframes blink{0%,50%{opacity:1;}50.01%,100%{opacity:0;}}</style>`;
            svg += `<rect width="100%" height="100%" fill="#050816" rx="14"/>`;
            svg += `<text x="${padding}" y="${padding - 6}" fill="#00ff7f" font-family="monospace" font-size="14">Marxolution // terminal.stats</text>`;

            lines.forEach((text, i) => {
              svg += `<text x="${padding}" y="${padding + lineHeight * (i + 1)}" fill="#00ff7f" font-family="monospace" font-size="16">&gt; ${text}</text>`;
            });

            svg += `<text x="${padding + 8}" y="${padding + lineHeight * (lines.length + 1)}" fill="#00ff7f" font-family="monospace" font-size="16" style="animation: blink 1s infinite;">_</text>`;
            svg += `</svg>`;

            fs.mkdirSync("assets", { recursive: true });
            fs.writeFileSync("assets/terminal-stats.svg", svg);

      - name: Commit and push
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add -A
          git commit -m "Update terminal stats" || echo "No changes to commit"
          git push
